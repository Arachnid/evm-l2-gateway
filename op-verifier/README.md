# @ensdomains/op-verifier

A complete Solidity library that facilitates sending CCIP-Read requests for Optimism state, and verifying the responses.

For a detailed readme and usage instructions, see the [monorepo readme](https://github.com/ensdomains/evmgateway/tree/main).

## Testing

Start up a devnet by following Optimism's instructions [here](https://community.optimism.io/docs/developers/build/dev-node/#do-i-need-this).

Then, deploy the L2 contract:

```
bun run hardhat deploy --network opDevnetL2
```

Followed by the L1 contract:

```
bun run hardhat deploy --network opDevnetL1
```

The L1 contracts contain a reference to the L2 contract, and so will require redeploying if the L2 contract changes.

Finally, run the tests:

```
hardhat test --network opDevnetL1
```

The tests will require small modifications to work on public testnets; specifically, contract addresses are currently fetched from `http://localhost:8080/addresses.json`; this will need to be made conditional on the network being used.

## Deployed addresses

### Optimism

#### L1

- OPVerifier = [0x0e8DA38565915B7e74e2d78F80ba1BF815F34116](https://sepolia.etherscan.io/address/0x0e8DA38565915B7e74e2d78F80ba1BF815F34116#code)
- TestL1 = [0x00198c6c94522A81698190ADF411641995Eb180c](https://sepolia.etherscan.io/address/0x00198c6c94522A81698190ADF411641995Eb180c#code
)
#### L2

- TestL2 = [0x94fbCE7ca1a0152cfC99F90f4421d31cf356c896](https://sepolia-optimism.etherscan.io/address/0x94fbCE7ca1a0152cfC99F90f4421d31cf356c896)

#### Gateway url

- https://op-sepolia-gateway-worker.ens-cf.workers.dev/{sender}/{data}.json

### Base

#### L1

- OPVerifier = [0xAdef74372444e716C0473dEe1F9Cb3108EFa3818](https://sepolia.etherscan.io/address/0xAdef74372444e716C0473dEe1F9Cb3108EFa3818#code
)
- TestL1 = [0x540C93800699C044dB8cf1f0F059ca0FA5CaED92](https://sepolia.etherscan.io/address/0x540C93800699C044dB8cf1f0F059ca0FA5CaED92#code)

#### L2

- TestL2 = [0x94fbCE7ca1a0152cfC99F90f4421d31cf356c896](https://sepolia.basescan.org/address/0x94fbCE7ca1a0152cfC99F90f4421d31cf356c896#code)

#### Gateway url

- https://base-sepolia-gateway-worker.ens-cf.workers.dev/{sender}/{data}.json

## OPOutputLookup

* Address: 0x650C74E213576313d25A92Bd8bFda1bA9BDE5faA
* Deterministic Deployment Proxy: 0x4e59b44847b379578588920cA78FbF26c0B4956C
* Salt: 0x0000000000000000000000000000000000000000000000000000000000000000
* Contract: lib/OPOutputLookup.sol:OPOutputLookup
* Solidity: 0.8.26
* Optimizer Runs: 200

Deployment Calldata

```
0x00000000000000000000000000000000000000000000000000000000000000006080604052348015600f57600080fd5b50611caa8061001f6000396000f3fe608060405234801561001057600080fd5b50600436106100885760003560e01c8063c81263f91161005b578063c81263f914610146578063d1d3ee3614610166578063e2dd1533146101b8578063e4ee14061461021457600080fd5b806311f2454f1461008d5780637a496563146100b6578063bab2c5ef146100d7578063babba784146100f7575b600080fd5b6100a061009b3660046115f0565b610227565b6040516100ad919061162b565b60405180910390f35b6100c96100c4366004611662565b610259565b6040516100ad929190611697565b6100ea6100e5366004611662565b61028d565b6040516100ad919061170c565b61010a6101053660046115f0565b61039d565b6040805194855263ffffffff90931660208501526001600160401b03909116918301919091526001600160a01b031660608201526080016100ad565b610159610154366004611743565b6103c1565b6040516100ad9190611760565b610179610174366004611780565b6104cd565b6040805195865260208601949094526001600160401b039092169284019290925260608301919091526001600160a01b0316608082015260a0016100ad565b6101cb6101c6366004611662565b6104f6565b6040805196875260208701959095526001600160401b039093169385019390935260608401526001600160a01b03909116608083015263ffffffff1660a082015260c0016100ad565b61010a6102223660046115f0565b610520565b604080516060810182526000808252602082018190529181019190915261025085858585610532565b95945050505050565b604080516060810182526000808252602082018190529181018290526102808585856106aa565b915091505b935093915050565b6040805160808101825260008082526020820181905291810182905260608101919091526102ba846103c1565b819060018111156102cd576102cd6116d4565b908160018111156102e0576102e06116d4565b9052506001815160018111156102f8576102f86116d4565b0361032b57600080600061030d8787876104f6565b50506020880193909352506060860152604085015250610396915050565b600081516001811115610340576103406116d4565b0361037d57600080610353868686610259565b6020850191909152805160608501526040908101516001600160801b031690840152506103969050565b604051636dfa9d6760e11b815260040160405180910390fd5b9392505050565b6000806000806103af88888888610878565b929b919a509850909650945050505050565b6000816001600160a01b031663f2b4e6176040518163ffffffff1660e01b8152600401602060405180830381865afa92505050801561041d575060408051601f3d908101601f1916820190925261041a918101906117c6565b60015b1561043c576001600160a01b0381161561043a5750600192915050565b505b816001600160a01b0316639b5f694a6040518163ffffffff1660e01b8152600401602060405180830381865afa925050508015610496575060408051601f3d908101601f19168201909252610493918101906117c6565b60015b1561037d576001600160a01b038116156104b35750600092915050565b50604051636dfa9d6760e11b815260040160405180910390fd5b60008060008060006104e189898989610a62565b94509450945094509450945094509450945094565b60008060008060008061050a898989610e4d565b949e939d50919b50995097509095509350505050565b6000806000806103af88888888610edc565b604080516060810182526000808252602082018190529181018290529061055886610faa565b60405163a25ae55760e01b8152600481018790529091506000906001600160a01b0383169063a25ae55790602401606060405180830381865afa1580156105a3573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906105c79190611866565b90508481602001516001600160801b0316426105e391906118e6565b1015610631578581602001516001600160801b03164261060391906118e6565b6040516328711f9f60e01b815260048101929092526024820152604481018690526064015b60405180910390fd5b60008411801561065857508381602001516001600160801b03164261065691906118e6565b115b156106a0578581602001516001600160801b03164261067791906118e6565b60405163107b0e1960e01b81526004810192909252602482015260448101859052606401610628565b9695505050505050565b6040805160608101825260008082526020820181905291810182905260006106d186610faa565b90506000816001600160a01b03166369f16eec6040518163ffffffff1660e01b8152600401602060405180830381865afa158015610713573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061073791906118f9565b9050600061074587426118e6565b9050600061075387426118e6565b9050825b83811161085b5760405163a25ae55760e01b8152600481018290526000906001600160a01b0387169063a25ae55790602401606060405180830381865afa1580156107a6573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906107ca9190611866565b90508381602001516001600160801b031611610851578815806107fa57508281602001516001600160801b031610155b1561080e5790965094506102859350505050565b8181602001516001600160801b03164261082891906118e6565b60405163107b0e1960e01b815260048101929092526024820152604481018a9052606401610628565b5060001901610757565b5060405163608d976560e11b815260048101899052602401610628565b600080600080600061088989611055565b604051632ee2a87f60e21b8152600481018a90529091506000906001600160a01b0383169063bb8aa1fc90602401606060405180830381865afa1580156108d4573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906108f89190611929565b80955081935082975050505061096c836001600160a01b031663bcef3b556040518163ffffffff1660e01b8152600401602060405180830381865afa158015610945573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061096991906118f9565b90565b95506001600160401b03811693508761098585426118e6565b10156109c8578861099f6001600160401b038616426118e6565b6040516366460f9d60e01b81526004810192909252602482015260448101899052606401610628565b6000871180156109e95750866109e76001600160401b038616426118e6565b115b15610a2b5788610a026001600160401b038616426118e6565b604051631fc476cf60e21b81526004810192909252602482015260448101889052606401610628565b610a34836110f5565b15610a55576040516336834a3160e21b8152600481018a9052602401610628565b5050945094509450949050565b60008080808080610a7388426118e6565b90506000610a808b611055565b90506000610a8e828461117c565b60405163254bd68360e01b815263ffffffff8d16600482015260248101829052600160448201529091506000906001600160a01b0384169063254bd68390606401600060405180830381865afa158015610aec573d6000803e3d6000fd5b505050506040513d6000823e601f3d908101601f19168201604052610b149190810190611972565b90508051600003610b3b5760405163d13b267760e01b8152600481018c9052602401610628565b6000610b8082600081518110610b5357610b53611b23565b60200260200101516020015160e081901c9160a082901c6001600160401b0316916001600160a01b031690565b92505050610b8d816110f5565b15610c8c5781600081518110610ba557610ba5611b23565b602002602001015160000151600003610bd45760405163d13b267760e01b8152600481018d9052602401610628565b836001600160a01b031663254bd6838e600185600081518110610bf957610bf9611b23565b602002602001015160000151610c0f91906118e6565b6040516001600160e01b031960e085901b16815263ffffffff929092166004830152602482015260016044820152606401600060405180830381865afa158015610c5d573d6000803e3d6000fd5b505050506040513d6000823e601f3d908101601f19168201604052610c859190810190611972565b9150610c92565b50610c98565b50610b3b565b80600081518110610cab57610cab611b23565b6020026020010151600001519850610cde81600081518110610ccf57610ccf611b23565b60200260200101516060015190565b9750610d0e81600081518110610cf657610cf6611b23565b6020026020010151604001516001600160401b031690565b965060008a118015610d315750610d258a426118e6565b876001600160401b0316105b15610d6a5788610d418b426118e6565b604051631fc476cf60e21b815260048101929092526024820152604481018b9052606401610628565b604051632ee2a87f60e21b8152600481018a90526001600160a01b0384169063bb8aa1fc90602401606060405180830381865afa158015610daf573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610dd39190611929565b909150905080955050846001600160a01b0316638b85902b6040518163ffffffff1660e01b8152600401602060405180830381865afa925050508015610e36575060408051601f3d908101601f19168201909252610e33918101906118f9565b60015b15610e3e5795505b50505050945094509450945094565b600080600080600080886001600160a01b0316633c9f397c6040518163ffffffff1660e01b8152600401602060405180830381865afa158015610e94573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610eb89190611b39565b9050610ec689828a8a610a62565b939d929c50909a50985090965090945092505050565b6000806000806000886001600160a01b0316633c9f397c6040518163ffffffff1660e01b8152600401602060405180830381865afa158015610f22573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610f469190611b39565b9050610f5489898989610878565b9297509095509350915063ffffffff80851690821614610f9e576040516323fa115960e21b81526004810189905263ffffffff808316602483015285166044820152606401610628565b50945094509450949050565b6000816001600160a01b0316639b5f694a6040518163ffffffff1660e01b8152600401602060405180830381865afa925050508015611006575060408051601f3d908101601f19168201909252611003918101906117c6565b60015b61102357604051638b4df23f60e01b815260040160405180910390fd5b6001600160a01b03811661104a57604051638b4df23f60e01b815260040160405180910390fd5b92915050565b919050565b6000816001600160a01b031663f2b4e6176040518163ffffffff1660e01b8152600401602060405180830381865afa9250505080156110b1575060408051601f3d908101601f191682019092526110ae918101906117c6565b60015b6110ce57604051635a23942360e11b815260040160405180910390fd5b6001600160a01b03811661104a57604051635a23942360e11b815260040160405180910390fd5b60006001826001600160a01b031663200d2ed26040518163ffffffff1660e01b8152600401602060405180830381865afa158015611137573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061115b9190611b56565b600281111561116c5761116c6116d4565b148061104a575061104a82611439565b6000806000905060006001856001600160a01b0316634d1975b46040518163ffffffff1660e01b8152600401602060405180830381865afa1580156111c5573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906111e991906118f9565b6111f391906118e6565b90505b80821161143157604051632ee2a87f60e21b8152600481018390526000906001600160a01b0387169063bb8aa1fc90602401606060405180830381865afa158015611245573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906112699190611929565b50604051632ee2a87f60e21b815260048101859052909250600091506001600160a01b0388169063bb8aa1fc90602401606060405180830381865afa1580156112b6573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906112da9190611929565b50915050856112ef836001600160401b031690565b6001600160401b03161115611314576113096001856118e6565b94505050505061104a565b600061132c6001600160401b03848116908416611b77565b6001600160401b031661133f86866118e6565b6113526001600160401b0386168a6118e6565b61135c9190611b96565b6113669190611bad565b6113709086611bcf565b604051632ee2a87f60e21b8152600481018290529091506000906001600160a01b038a169063bb8aa1fc90602401606060405180830381865afa1580156113bb573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906113df9190611929565b5091505060006113f5826001600160401b031690565b905088816001600160401b03161161141957611412836001611bcf565b9650611427565b6114246001846118e6565b95505b50505050506111f6565b949350505050565b60006002826001600160a01b031663200d2ed26040518163ffffffff1660e01b8152600401602060405180830381865afa15801561147b573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061149f9190611b56565b60028111156114b0576114b06116d4565b036114bd57506000919050565b6040516331bc0c2360e21b8152600160048201526001600160a01b0383169063c6f0308c9060240160e060405180830381865afa92505050801561151e575060408051601f3d908101601f1916820190925261151b91810190611be2565b60015b61152a57506001919050565b50506040516331bc0c2360e21b815260006004820181905295506001600160a01b038816945063c6f0308c935060240191506115639050565b60e060405180830381865afa158015611580573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906115a49190611be2565b505050505091505060006001600160a01b0316816001600160a01b0316146115cf5750600192915050565b50600092915050565b6001600160a01b03811681146115ed57600080fd5b50565b6000806000806080858703121561160657600080fd5b8435611611816115d8565b966020860135965060408601359560600135945092505050565b6060810161104a8284805182526001600160801b0360208201511660208301526001600160801b0360408201511660408301525050565b60008060006060848603121561167757600080fd5b8335611682816115d8565b95602085013595506040909401359392505050565b828152608081016103966020830184805182526001600160801b0360208201511660208301526001600160801b0360408201511660408301525050565b634e487b7160e01b600052602160045260246000fd5b6002811061170857634e487b7160e01b600052602160045260246000fd5b9052565b600060808201905061171f8284516116ea565b60208301516020830152604083015160408301526060830151606083015292915050565b60006020828403121561175557600080fd5b8135610396816115d8565b6020810161104a82846116ea565b63ffffffff811681146115ed57600080fd5b6000806000806080858703121561179657600080fd5b84356117a1816115d8565b935060208501356117b18161176e565b93969395505050506040820135916060013590565b6000602082840312156117d857600080fd5b8151610396816115d8565b634e487b7160e01b600052604160045260246000fd5b60405160a081016001600160401b038111828210171561181b5761181b6117e3565b60405290565b604051601f8201601f191681016001600160401b0381118282101715611849576118496117e3565b604052919050565b6001600160801b03811681146115ed57600080fd5b6000606082840312801561187957600080fd5b50604051606081016001600160401b038111828210171561189c5761189c6117e3565b6040528251815260208301516118b181611851565b602082015260408301516118c481611851565b60408201529392505050565b634e487b7160e01b600052601160045260246000fd5b8181038181111561104a5761104a6118d0565b60006020828403121561190b57600080fd5b5051919050565b80516001600160401b038116811461105057600080fd5b60008060006060848603121561193e57600080fd5b83516119498161176e565b925061195760208501611912565b91506040840151611967816115d8565b809150509250925092565b60006020828403121561198457600080fd5b81516001600160401b0381111561199a57600080fd5b8201601f810184136119ab57600080fd5b80516001600160401b038111156119c4576119c46117e3565b8060051b6119d460208201611821565b918252602081840181019290810190878411156119f057600080fd5b6020850192505b83831015611b185782516001600160401b03811115611a1557600080fd5b850160a0818a03601f19011215611a2b57600080fd5b611a336117f9565b6020828101518252604083015190820152611a5060608301611912565b60408201526080820151606082015260a08201516001600160401b03811115611a7857600080fd5b60208184010192505089601f830112611a9057600080fd5b81516001600160401b03811115611aa957611aa96117e3565b611abc601f8201601f1916602001611821565b8181528b6020838601011115611ad157600080fd5b60005b82811015611af057602081860181015183830182015201611ad4565b50600060208383010152806080840152505080845250506020820191506020830192506119f7565b979650505050505050565b634e487b7160e01b600052603260045260246000fd5b600060208284031215611b4b57600080fd5b81516103968161176e565b600060208284031215611b6857600080fd5b81516003811061039657600080fd5b6001600160401b03828116828216039081111561104a5761104a6118d0565b808202811582820484141761104a5761104a6118d0565b600082611bca57634e487b7160e01b600052601260045260246000fd5b500490565b8082018082111561104a5761104a6118d0565b600080600080600080600060e0888a031215611bfd57600080fd5b8751611c088161176e565b6020890151909750611c19816115d8565b6040890151909650611c2a816115d8565b6060890151909550611c3b81611851565b608089015160a08a01519195509350611c5381611851565b60c0890151909250611c6481611851565b809150509295989194975092955056fea2646970667358221220903f18466585ccd0b748fffa51309ec47986ea3ed9de56671cf0d08f9dbc7ee264736f6c634300081a0033
```

## Testing gateway

```
TARGET_ADDRESS=$TEST_L1_ADDRESS PROVIDER_URL=$L1_PROVIDER_URL npx hardhat run ../l1-verifier/scripts/remote.ts --network sepolia
```