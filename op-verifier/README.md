# @ensdomains/op-verifier

A complete Solidity library that facilitates sending CCIP-Read requests for Optimism state, and verifying the responses.

For a detailed readme and usage instructions, see the [monorepo readme](https://github.com/ensdomains/evmgateway/tree/main).

## Testing

Start up a devnet by following Optimism's instructions [here](https://community.optimism.io/docs/developers/build/dev-node/#do-i-need-this).

Then, deploy the L2 contract:

```
bun run hardhat deploy --network opDevnetL2
```

Followed by the L1 contract:

```
bun run hardhat deploy --network opDevnetL1
```

The L1 contracts contain a reference to the L2 contract, and so will require redeploying if the L2 contract changes.

Finally, run the tests:

```
hardhat test --network opDevnetL1
```

The tests will require small modifications to work on public testnets; specifically, contract addresses are currently fetched from `http://localhost:8080/addresses.json`; this will need to be made conditional on the network being used.

## Deployed addresses

### Optimism

#### L1

- OPVerifier = [0x0e8DA38565915B7e74e2d78F80ba1BF815F34116](https://sepolia.etherscan.io/address/0x0e8DA38565915B7e74e2d78F80ba1BF815F34116#code)
- TestL1 = [0x00198c6c94522A81698190ADF411641995Eb180c](https://sepolia.etherscan.io/address/0x00198c6c94522A81698190ADF411641995Eb180c#code
)
#### L2

- TestL2 = [0x94fbCE7ca1a0152cfC99F90f4421d31cf356c896](https://sepolia-optimism.etherscan.io/address/0x94fbCE7ca1a0152cfC99F90f4421d31cf356c896)

#### Gateway url

- https://op-sepolia-gateway-worker.ens-cf.workers.dev/{sender}/{data}.json

### Base

#### L1

- OPVerifier = [0xAdef74372444e716C0473dEe1F9Cb3108EFa3818](https://sepolia.etherscan.io/address/0xAdef74372444e716C0473dEe1F9Cb3108EFa3818#code
)
- TestL1 = [0x540C93800699C044dB8cf1f0F059ca0FA5CaED92](https://sepolia.etherscan.io/address/0x540C93800699C044dB8cf1f0F059ca0FA5CaED92#code)

#### L2

- TestL2 = [0x94fbCE7ca1a0152cfC99F90f4421d31cf356c896](https://sepolia.basescan.org/address/0x94fbCE7ca1a0152cfC99F90f4421d31cf356c896#code)

#### Gateway url

- https://base-sepolia-gateway-worker.ens-cf.workers.dev/{sender}/{data}.json

## OPOutputLookup

* Address: 0x4c8b8505e60f35Fe7Ad5882c9265f5Bf39AC45D1
* Deterministic Deployment Proxy: 0x4e59b44847b379578588920cA78FbF26c0B4956C

Deployment Calldata

```
0x00000000000000000000000000000000000000000000000000000000000000006080604052348015600f57600080fd5b506118d68061001f6000396000f3fe608060405234801561001057600080fd5b50600436106100885760003560e01c8063c81263f91161005b578063c81263f914610146578063d1d3ee3614610166578063e2dd1533146101b8578063e4ee14061461021457600080fd5b806311f2454f1461008d5780637a496563146100b6578063bab2c5ef146100d7578063babba784146100f7575b600080fd5b6100a061009b3660046112b0565b610227565b6040516100ad91906112eb565b60405180910390f35b6100c96100c4366004611322565b610259565b6040516100ad929190611357565b6100ea6100e5366004611322565b61028d565b6040516100ad91906113cc565b61010a6101053660046112b0565b61039d565b6040805194855263ffffffff90931660208501526001600160401b03909116918301919091526001600160a01b031660608201526080016100ad565b610159610154366004611403565b6103c1565b6040516100ad9190611420565b610179610174366004611440565b6104cd565b6040805195865260208601949094526001600160401b039092169284019290925260608301919091526001600160a01b0316608082015260a0016100ad565b6101cb6101c6366004611322565b6104f6565b6040805196875260208701959095526001600160401b039093169385019390935260608401526001600160a01b03909116608083015263ffffffff1660a082015260c0016100ad565b61010a6102223660046112b0565b610520565b604080516060810182526000808252602082018190529181019190915261025085858585610532565b95945050505050565b604080516060810182526000808252602082018190529181018290526102808585856106aa565b915091505b935093915050565b6040805160808101825260008082526020820181905291810182905260608101919091526102ba846103c1565b819060018111156102cd576102cd611394565b908160018111156102e0576102e0611394565b9052506001815160018111156102f8576102f8611394565b0361032b57600080600061030d8787876104f6565b50506020880193909352506060860152604085015250610396915050565b60008151600181111561034057610340611394565b0361037d57600080610353868686610259565b6020850191909152805160608501526040908101516001600160801b031690840152506103969050565b604051636dfa9d6760e11b815260040160405180910390fd5b9392505050565b6000806000806103af88888888610878565b929b919a509850909650945050505050565b6000816001600160a01b031663f2b4e6176040518163ffffffff1660e01b8152600401602060405180830381865afa92505050801561041d575060408051601f3d908101601f1916820190925261041a91810190611486565b60015b1561043c576001600160a01b0381161561043a5750600192915050565b505b816001600160a01b0316639b5f694a6040518163ffffffff1660e01b8152600401602060405180830381865afa925050508015610496575060408051601f3d908101601f1916820190925261049391810190611486565b60015b1561037d576001600160a01b038116156104b35750600092915050565b50604051636dfa9d6760e11b815260040160405180910390fd5b60008060008060006104e189898989610ace565b94509450945094509450945094509450945094565b60008060008060008061050a898989610d5c565b949e939d50919b50995097509095509350505050565b6000806000806103af88888888610deb565b604080516060810182526000808252602082018190529181018290529061055886610eb9565b60405163a25ae55760e01b8152600481018790529091506000906001600160a01b0383169063a25ae55790602401606060405180830381865afa1580156105a3573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906105c79190611528565b90508481602001516001600160801b0316426105e391906115a4565b1015610631578581602001516001600160801b03164261060391906115a4565b6040516328711f9f60e01b815260048101929092526024820152604481018690526064015b60405180910390fd5b60008411801561065857508381602001516001600160801b03164261065691906115a4565b115b156106a0578581602001516001600160801b03164261067791906115a4565b60405163107b0e1960e01b81526004810192909252602482015260448101859052606401610628565b9695505050505050565b6040805160608101825260008082526020820181905291810182905260006106d186610eb9565b90506000816001600160a01b03166369f16eec6040518163ffffffff1660e01b8152600401602060405180830381865afa158015610713573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061073791906115b7565b9050600061074587426115a4565b9050600061075387426115a4565b9050825b83811161085b5760405163a25ae55760e01b8152600481018290526000906001600160a01b0387169063a25ae55790602401606060405180830381865afa1580156107a6573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906107ca9190611528565b90508381602001516001600160801b031611610851578815806107fa57508281602001516001600160801b031610155b1561080e5790965094506102859350505050565b8181602001516001600160801b03164261082891906115a4565b60405163107b0e1960e01b815260048101929092526024820152604481018a9052606401610628565b5060001901610757565b5060405163608d976560e11b815260048101899052602401610628565b600080600080600061088989610f64565b604051632ee2a87f60e21b8152600481018a90529091506000906001600160a01b0383169063bb8aa1fc90602401606060405180830381865afa1580156108d4573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906108f891906115e7565b80955081935082975050505061096c836001600160a01b031663bcef3b556040518163ffffffff1660e01b8152600401602060405180830381865afa158015610945573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061096991906115b7565b90565b95506001600160401b03811693508761098585426115a4565b10156109c8578861099f6001600160401b038616426115a4565b6040516366460f9d60e01b81526004810192909252602482015260448101899052606401610628565b6000871180156109e95750866109e76001600160401b038616426115a4565b115b15610a2b5788610a026001600160401b038616426115a4565b604051631fc476cf60e21b81526004810192909252602482015260448101889052606401610628565b6001836001600160a01b031663200d2ed26040518163ffffffff1660e01b8152600401602060405180830381865afa158015610a6b573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610a8f9190611630565b6002811115610aa057610aa0611394565b03610ac1576040516309f9a0e960e41b8152600481018a9052602401610628565b5050945094509450949050565b60008080808080610adf88426115a4565b90506000610aec8b610f64565b90506000610afa8284611004565b60405163254bd68360e01b815263ffffffff8d16600482015260248101829052600160448201529091506000906001600160a01b0384169063254bd68390606401600060405180830381865afa158015610b58573d6000803e3d6000fd5b505050506040513d6000823e601f3d908101601f19168201604052610b809190810190611651565b90508051600003610ba75760405163d13b267760e01b8152600481018c9052602401610628565b80600081518110610bba57610bba611802565b6020026020010151600001519850610bed81600081518110610bde57610bde611802565b60200260200101516060015190565b9750610c1d81600081518110610c0557610c05611802565b6020026020010151604001516001600160401b031690565b965060008a118015610c405750610c348a426115a4565b876001600160401b0316105b15610c795788610c508b426115a4565b604051631fc476cf60e21b815260048101929092526024820152604481018b9052606401610628565b604051632ee2a87f60e21b8152600481018a90526001600160a01b0384169063bb8aa1fc90602401606060405180830381865afa158015610cbe573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610ce291906115e7565b909150905080955050846001600160a01b0316638b85902b6040518163ffffffff1660e01b8152600401602060405180830381865afa925050508015610d45575060408051601f3d908101601f19168201909252610d42918101906115b7565b60015b15610d4d5795505b50505050945094509450945094565b600080600080600080886001600160a01b0316633c9f397c6040518163ffffffff1660e01b8152600401602060405180830381865afa158015610da3573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610dc79190611818565b9050610dd589828a8a610ace565b939d929c50909a50985090965090945092505050565b6000806000806000886001600160a01b0316633c9f397c6040518163ffffffff1660e01b8152600401602060405180830381865afa158015610e31573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610e559190611818565b9050610e6389898989610878565b9297509095509350915063ffffffff80851690821614610ead576040516323fa115960e21b81526004810189905263ffffffff808316602483015285166044820152606401610628565b50945094509450949050565b6000816001600160a01b0316639b5f694a6040518163ffffffff1660e01b8152600401602060405180830381865afa925050508015610f15575060408051601f3d908101601f19168201909252610f1291810190611486565b60015b610f3257604051638b4df23f60e01b815260040160405180910390fd5b6001600160a01b038116610f5957604051638b4df23f60e01b815260040160405180910390fd5b92915050565b919050565b6000816001600160a01b031663f2b4e6176040518163ffffffff1660e01b8152600401602060405180830381865afa925050508015610fc0575060408051601f3d908101601f19168201909252610fbd91810190611486565b60015b610fdd57604051635a23942360e11b815260040160405180910390fd5b6001600160a01b038116610f5957604051635a23942360e11b815260040160405180910390fd5b6000806000905060006001856001600160a01b0316634d1975b46040518163ffffffff1660e01b8152600401602060405180830381865afa15801561104d573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061107191906115b7565b61107b91906115a4565b90505b80821161129057604051632ee2a87f60e21b8152600481018390526000906001600160a01b0387169063bb8aa1fc90602401606060405180830381865afa1580156110cd573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906110f191906115e7565b50604051632ee2a87f60e21b815260048101859052909250600091506001600160a01b0388169063bb8aa1fc90602401606060405180830381865afa15801561113e573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061116291906115e7565b509150506000611178836001600160401b031690565b61118b906001600160401b038416611835565b6001600160401b031661119e86866115a4565b6111b16001600160401b0386168a6115a4565b6111bb9190611854565b6111c5919061186b565b6111cf908661188d565b604051632ee2a87f60e21b8152600481018290529091506000906001600160a01b038a169063bb8aa1fc90602401606060405180830381865afa15801561121a573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061123e91906115e7565b509150506000611254826001600160401b031690565b905088816001600160401b0316116112785761127183600161188d565b9650611286565b6112836001846115a4565b95505b505050505061107e565b949350505050565b6001600160a01b03811681146112ad57600080fd5b50565b600080600080608085870312156112c657600080fd5b84356112d181611298565b966020860135965060408601359560600135945092505050565b60608101610f598284805182526001600160801b0360208201511660208301526001600160801b0360408201511660408301525050565b60008060006060848603121561133757600080fd5b833561134281611298565b95602085013595506040909401359392505050565b828152608081016103966020830184805182526001600160801b0360208201511660208301526001600160801b0360408201511660408301525050565b634e487b7160e01b600052602160045260246000fd5b600281106113c857634e487b7160e01b600052602160045260246000fd5b9052565b60006080820190506113df8284516113aa565b60208301516020830152604083015160408301526060830151606083015292915050565b60006020828403121561141557600080fd5b813561039681611298565b60208101610f5982846113aa565b63ffffffff811681146112ad57600080fd5b6000806000806080858703121561145657600080fd5b843561146181611298565b935060208501356114718161142e565b93969395505050506040820135916060013590565b60006020828403121561149857600080fd5b815161039681611298565b634e487b7160e01b600052604160045260246000fd5b60405160a081016001600160401b03811182821017156114db576114db6114a3565b60405290565b604051601f8201601f191681016001600160401b0381118282101715611509576115096114a3565b604052919050565b80516001600160801b0381168114610f5f57600080fd5b6000606082840312801561153b57600080fd5b50604051606081016001600160401b038111828210171561155e5761155e6114a3565b6040528251815261157160208401611511565b602082015261158260408401611511565b60408201529392505050565b634e487b7160e01b600052601160045260246000fd5b81810381811115610f5957610f5961158e565b6000602082840312156115c957600080fd5b5051919050565b80516001600160401b0381168114610f5f57600080fd5b6000806000606084860312156115fc57600080fd5b83516116078161142e565b9250611615602085016115d0565b9150604084015161162581611298565b809150509250925092565b60006020828403121561164257600080fd5b81516003811061039657600080fd5b60006020828403121561166357600080fd5b81516001600160401b0381111561167957600080fd5b8201601f8101841361168a57600080fd5b80516001600160401b038111156116a3576116a36114a3565b8060051b6116b3602082016114e1565b918252602081840181019290810190878411156116cf57600080fd5b6020850192505b838310156117f75782516001600160401b038111156116f457600080fd5b850160a0818a03601f1901121561170a57600080fd5b6117126114b9565b602082810151825260408301519082015261172f606083016115d0565b60408201526080820151606082015260a08201516001600160401b0381111561175757600080fd5b60208184010192505089601f83011261176f57600080fd5b81516001600160401b03811115611788576117886114a3565b61179b601f8201601f19166020016114e1565b8181528b60208386010111156117b057600080fd5b60005b828110156117cf576020818601810151838301820152016117b3565b50600060208383010152806080840152505080845250506020820191506020830192506116d6565b979650505050505050565b634e487b7160e01b600052603260045260246000fd5b60006020828403121561182a57600080fd5b81516103968161142e565b6001600160401b038281168282160390811115610f5957610f5961158e565b8082028115828204841417610f5957610f5961158e565b60008261188857634e487b7160e01b600052601260045260246000fd5b500490565b80820180821115610f5957610f5961158e56fea26469706673582212206f41b1a17e110ca91e0a806c8f2e22c45065f5e84eef109a6df60ca40406147d64736f6c634300081a0033
```

## Testing gateway

```
TARGET_ADDRESS=$TEST_L1_ADDRESS PROVIDER_URL=$L1_PROVIDER_URL npx hardhat run ../l1-verifier/scripts/remote.ts --network sepolia
```